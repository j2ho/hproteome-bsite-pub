{% extends "base_generic.html" %}

{% load static %}
{% block content %}
<div>
    <br>
    <div class="para_title">&nbsp&nbsp{{domain}} [{{domain.resnum}}]</div>
    <h3>Query domain: {{domain.name}}</h3>
        <button type="button" class="collapsible"><center><h4>Show Structure on PV viewer [click]</h4></center></button>
	<div class="contentcollapse">

        <table>
            <tbody>
                <tr>
                    <td>
                        <div id=viewer>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        </div>
        <ul>
        <li><h4><a href="https://galaxy.seoklab.org/data/{{domain.domainfile}}">Download structural domain in PDB
                    format</a></h4></li>
        <li><h4><a id="model_1">See structrural domain only (PV viewer)</a></h4></li>
        </ul>
        <hr>
            <br>
        {% if domain.seqcsvfile %}
        <h3>Sequence Result</h3>
        <table class="view">
            <tbody>
                <tr>
                    <th>Site No.</th>
                    <th>Representative Ligand</th>
                    <th><br>Templates<p>(PDBID_CHAIN_NUM_TMSCORE)</p></th>
                    <th style="width:270px">Alternative Ligands</th>
                </tr>
            {% for site in domain.sites.all %}
            {% if site.method == 'sequence' %}
            {% if site.ligands.all %}
            {% if site.rank <= 10 %}
                <tr>
                    <td>{{site.rank}}</td>
                    <td>
                        {% for ligand in site.ligands.all %}
                        {% if ligand.ligcoord == site.coordinate %}
                        <p><strong>{{ligand}}</strong></p>
                        {% if ligand.dockedfile %}
                        <p><a href="{{ligand.get_absolute_url}}" target = "_blank">See Ligand Details (Mol*)</a></p>
                        <a id="model_{{ligand.liguniquename}}"><font size="2">View on PV</font></a>
                        {% endif %}
                        {% if ligand.mol2file %}
                        <font size="3">|</font>
                        <a href="https://galaxy.seoklab.org/data/{{ligand.mol2file}}"><font size="2">Download docking
                                pose</font></a>
                        <font size="3">|</font>
                        {% endif %}
                        <a href="https://www.rcsb.org/ligand/{{ligand.ligname}}"><font size="2">RCSB Info</font></a>
                        <p></p>
                        <td>
                            {% for template in ligand.templates.all %}
                            <p><a
                                   href="https://galaxy.seoklab.org/cgi-bin/submit_SITE_DOCK.cgi?job=docking&job_type=SITE_DOCK&template={{template.templ_chain_lignum}}&lig={{ligand.ligname}}&domain={{domain.name}}">{{template}}</a></p>
                            {% endfor %}
                        </td>
                        {% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        {% for ligand in site.ligands.all %}
                        {% if ligand.ligcoord != site.coordinate %}
                        {% if ligand.ligrank < 20 %}
                        <a href="https://www.rcsb.org/ligand/{{ligand}}">&nbsp{{ligand}}</a>
                        {% endif %}
                        {% endif %}
                        {% endfor %}
                        </td>
                </tr>
            {% endif %}
            {% endif %}
            {% endif %}
            {% endfor %}
            </tbody>
        </table>
            {% else %}
            <p>There are no ligands predicted by Sequence Search</p>
        {% endif %}

        <br>
        {% if domain.strcsvfile %}
        <h3>Structure Result </h3>
        <br>
        <table class="view">
            <tbody>
                <tr>
                    <th>Site No.</th>
                    <th>Representative Ligand</th>
                    <th><br>Templates<p>(PDBID_CHAIN_NUM_TMSCORE)</p></th>
                    <th style="width:270px">Alternative Ligands</th>
                </tr>
            {% for site in domain.sites.all %}
            {% if site.method == 'structure' %}
            {% if site.ligands.all %}
            {% if site.rank <= 10 %}
                <tr>
                    <td>{{site.rank}}</td>
                    <td>
                        {% for ligand in site.ligands.all %}
                        {% if ligand.ligcoord == site.coordinate %}
                        <p><strong>{{ligand}}</strong></p>
                        {% if ligand.dockedfile %}
                        <p><a href="{{ligand.get_absolute_url}}" target = "_blank">See Ligand Details (Mol*)</a></p>
                        <a id="model_{{ligand.liguniquename}}"><font size="2">View on PV</font></a>
                        {% endif %}
                        {% if ligand.mol2file %}
                        <font size="3">|</font>
                        <a href="https://galaxy.seoklab.org/data/{{ligand.mol2file}}"><font size="2">Download docking
                                pose</font></a>
                        <font size="3">|</font>
                        {% endif %}
                        <a href="https://www.rcsb.org/ligand/{{ligand.ligname}}"><font size="2">RCSB Info</font></a>
                        <p></p>
                        <td>
                            {% for template in ligand.templates.all %}
                            <p><a
                                   href="https://galaxy.seoklab.org/cgi-bin/submit_SITE_DOCK.cgi?job=docking&job_type=SITE_DOCK&template={{template.templ_chain_lignum}}&lig={{ligand.ligname}}&domain={{domain.name}}">{{template}}</a></p>
                            {% endfor %}
                        </td>
                        {% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        {% for ligand in site.ligands.all %}
                        {% if ligand.ligcoord != site.coordinate %}
                        {% if ligand.ligrank < 20 %}
                        <a href="https://www.rcsb.org/ligand/{{ligand}}">&nbsp{{ligand}}</a>
                        {% endif %}
                        {% endif %}
                        {% endfor %}
                    </td>
                </tr>
            {% endif %}
            {% endif %}
            {% endif %}
            {% endfor %}
            </tbody>
        </table>
            {% else %}
            <p>There are no ligands predicted by Structure Search</p>
        {% endif %}

        {% if domain.seqcsvfile %}
        <h3><li>Sequence search results (in csv) - <a
                                                   href="https://galaxy.seoklab.org/data/{{domain.seqcsvfile}}">[Download]</a></li></h3>
    {% endif %}
        {% if domain.strcsvfile %}
        <h3><li>Structure search results (in csv)   - <a
                                                          href="https://galaxy.seoklab.org/data/{{domain.strcsvfile}}">[Download]</a></li></h3>
    {% endif %}
    <hr>
    <h3>You can also get docking results for alternative ligands using <a
            href="https://galaxy.seoklab.org/cgi-bin/submit.cgi?type=SITE_DOCK"><strong>[HProteome-BSite
            Docking]</strong></a> | <a href={% url 'helpdock'%}>[Help Page - Docking]</a></h3>
  </div>
  <br>
    <script>

var coll = document.getElementsByClassName("collapsible");
var i;
var i;

for (i = 0; i < coll.length; i++) {
coll[i].addEventListener("click", function() {
this.classList.toggle("active");
var content = this.nextElementSibling;
if (content.style.display === "block") {
  content.style.display = "none";
} else {
  content.style.display = "block";
}
});
}
    </script>
            <script src="{% static '/pv/js/jquery-2.0.2.min.js' %}"></script>
            <script src="{% static '/pv/js/jquery-ui.min.js' %}"></script>
            <script src="{% static '/pv/src/gl-matrix.js' %}"></script>
            <script src="{% static '/pv/src/core.js' %}"></script>
            <script src="{% static '/pv/src/geom.js' %}"></script>
            <script src="{% static '/pv/src/trace.js' %}"></script>
            <script src="{% static '/pv/src/mol.js' %}"></script>
            <script src="{% static '/pv/src/io.js' %}"></script>
            <script src="{% static '/pv/src/vert-assoc.js' %}"></script>
            <script src="{% static '/pv/src/buffer-allocators.js' %}"></script>
            <script src="{% static '/pv/src/vertex-array-base.js' %}"></script>
            <script src="{% static '/pv/src/indexed-vertex-array.js' %}"></script>
            <script src="{% static '/pv/src/vertex-array.js' %}"></script>
            <script src="{% static '/pv/src/chain-data.js' %}"></script>
            <script src="{% static '/pv/src/geom-builders.js' %}"></script>
            <script src="{% static '/pv/src/scene.js' %}"></script>
            <script src="{% static '/pv/src/render.js' %}"></script>
            <script src="{% static '/pv/src/shade.js' %}"></script>
            <script src="{% static '/pv/src/cam.js' %}"></script>
            <script src="{% static '/pv/src/shaders.js' %}"></script>
            <script src="{% static '/pv/src/framebuffer.js' %}"></script>
            <script src="{% static '/pv/src/slab.js' %}"></script>
            <script src="{% static '/pv/src/animation.js' %}"></script>
            <script src="{% static '/pv/src/viewer.js' %}"></script>
            <script>
            var pv = pv.Viewer(document.getElementById('viewer'),
                    { quality : 'medium', width: 700, height : 500,
                      antialias : true, outline : false,
                      background : 'white',
                      slabMode : 'auto'});

            var structure;

            function load() {
                pv.clear();
                $.ajax({ url : '/data/{{domain.domainfile}}', success : function(data) {
                        structure = io.pdb(data);
                        var protein = structure.select('protein');
                        var ligand  = structure.select('ligand');
                        var intr    = protein.selectWithin(ligand, {radius: 4.5, matchResidues: '1'});
                        var intrSC  = intr.select({not_anames : ['N','C','O','H']});
                        var camera  = structure.selectWithin(ligand, {radius: 10.0, matchResidues: '1'});

                        pv.cartoon('protein', protein, {color: color.bySS()});
                        pv.ballsAndSticks('ligand', ligand, {color: color.byElement2()});

                        pv.fitTo(camera);

                        }})
                }
function load_pdb(ligand) {
                pv.clear();
    $.ajax({ url : '/data/'+ligand, success : function(data) {
                        structure = io.pdb(data);
                        var protein = structure.select('protein');
                        var ligand  = structure.select('ligand');
                        var intr    = protein.selectWithin(ligand, {radius: 4.5, matchResidues: '1'});
                        var intrSC  = intr.select({not_anames : ['N','C','O','H']});
                        var camera  = structure.selectWithin(ligand, {radius: 10.0, matchResidues: '1'});

                        pv.cartoon('protein', protein, {color: color.bySS()});
                        pv.ballsAndSticks('ligand', ligand, {color: color.byElement2()});

                        pv.fitTo(camera);

                        }})
                }
            {% for site in domain.sites.all %}
                    {% for ligand in site.ligands.all %}
                        {% if ligand.dockedfile %}
                            function model_{{ligand.liguniquename}}() {
                            load_pdb('{{ligand.dockedfile}}');
                            }
                        {% endif %}
                    {% endfor %}
            {% endfor %}



            function model_1() {
                load();
            }
        document.addEventListener('DOMContentLoaded', model_1);

            $('#model_1').click(model_1);
            {% for site in domain.sites.all %}
                    {% for ligand in site.ligands.all %}
                        {% if ligand.dockedfile %}
                $('#model_{{ligand.liguniquename}}').click(model_{{ligand.liguniquename}});
                        {% if ligand.ligrank == 1%}
                        document.addEventListener('DOMContentLoaded', model_{{ligand.liguniquename}});
                        {% endif %}
                        {% endif %}
                    {% endfor %}
            {% endfor %}

            </script>
{% endblock %}
